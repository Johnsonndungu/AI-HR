<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard | AI Recruitment System</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; background: #f5f7fb; margin: 0; color: #1f2933; }
    header { background: #1b3063; color: #fff; padding: 1.2rem 2rem; display: flex; justify-content: space-between; align-items: center; }
    header h1 { margin: 0; font-size: 1.4rem; }
    header button { background: #dc2626; border: none; color: #fff; padding: 0.6rem 1rem; border-radius: 5px; cursor: pointer; }
    .container { max-width: 1100px; margin: 2rem auto; padding: 1rem; }
    .card { background: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(60,60,109,0.2); padding: 1.5rem; margin-bottom: 2rem; }
    h2 { margin-top: 0; color: #0f172a; }
    label { font-weight: bold; display: block; margin-top: 1rem; }
    textarea, input[type="text"] { width: 100%; padding: 0.8rem; border-radius: 5px; border: 1px solid #cbd5e1; margin-top: 0.5rem; }
    input[type="file"] { margin-top: 0.8rem; }
    .upload-area { border: 2px dashed #94a3b8; padding: 1.5rem; text-align: center; border-radius: 6px; background: #f8fafc; margin-top: 1rem; }
    button.primary { margin-top: 1.5rem; padding: 0.9rem 1.5rem; background: #2563eb; border: none; color: #fff; font-size: 1rem; border-radius: 5px; cursor: pointer; }
    button.primary:hover { background: #1e40af; }
    .results { display: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; }
    table th, table td { padding: 0.8rem; border-bottom: 1px solid #e5e7eb; text-align: left; }
    table th { background: #f1f5f9; }
    .score { font-weight: bold; color: #16a34a; }
    .progress-container { margin-top: 0.5rem; }
    progress { width: 100%; height: 20px; }
    .note { font-size: 0.85rem; color: #475569; margin-top: 0.5rem; }
  </style>
</head>
<body>

<header>
  <h1>AI Recruitment Dashboard</h1>
  <button onclick="logout()">Logout</button>
</header>

<div class="container">

  <!-- Job Description -->
  <div class="card">
    <h2>1. Job Description</h2>
    <label>Job Title</label>
    <input type="text" id="jobTitle" placeholder="e.g. Backend Developer" />
    <label>Paste Job Description</label>
    <textarea id="jobText" rows="6" placeholder="Paste job description here..." oninput="toggleJobInput()"></textarea>
    <label>Or Upload Job Description (PDF / DOCX)</label>
    <input type="file" id="jobFile" accept=".pdf,.doc,.docx" onchange="toggleJobInput()" />
    <div class="note">Only one job description method is allowed.</div>
  </div>

  <!-- CV Upload -->
  <div class="card">
    <h2>2. Upload Candidate CVs</h2>
    <div class="upload-area">
      <p>Select candidate CVs (PDF / DOCX)</p>
      <input type="file" id="cvFiles" accept=".pdf,.doc,.docx" multiple />
    </div>
  </div>

  <!-- Submit -->
  <div class="card">
    <button class="primary" onclick="startScreening()">Start AI Screening</button>
  </div>

  <!-- Results -->
  <div class="card results" id="results">
    <h2>3. Ranked Candidates</h2>
    <table>
      <thead>
        <tr>
          <th>Rank</th>
          <th>Applicant</th>
          <th>Contact</th>
          <th>Match Score</th>
          <th>Key Skills Matched</th>
          <th>Explanation</th>
          <th>Progress</th>
        </tr>
      </thead>
      <tbody id="resultsBody"></tbody>
    </table>
  </div>

</div>

<script>
function toggleJobInput() {
  const jobText = document.getElementById('jobText');
  const jobFile = document.getElementById('jobFile');
  if (jobText.value.trim()) jobFile.disabled = true;
  else if (jobFile.files.length) jobText.disabled = true;
  else { jobText.disabled = false; jobFile.disabled = false; }
}

function logout() {
  fetch('/logout').then(() => window.location.href = '/login');
}

function startScreening() {
  const jobTitle = document.getElementById('jobTitle').value;
  const jobText = document.getElementById('jobText').value;
  const jobFile = document.getElementById('jobFile').files[0];
  const cvFiles = document.getElementById('cvFiles').files;

  if (!jobText && !jobFile) { alert('Provide a job description'); return; }
  if (!cvFiles.length) { alert('Upload at least one CV'); return; }

  const formData = new FormData();
  formData.append('job_title', jobTitle);
  if (jobText) formData.append('job_text', jobText);
  if (jobFile) formData.append('job_file', jobFile);
  for (let i=0; i<cvFiles.length; i++) formData.append('cvs', cvFiles[i]);

  fetch('/screen', { method: 'POST', body: formData })
    .then(r => r.json())
    .then(data => {
      if (data.error) { alert(data.error); return; }
      showResults(data.job_ids, cvFiles);
    })
    .catch(e => alert('Screening failed: ' + e));
}

function showResults(jobIds, cvFiles) {
  const resultsDiv = document.getElementById('results');
  const tbody = document.getElementById('resultsBody');
  tbody.innerHTML = '';

  // Initialize rows
  jobIds.forEach((id, index) => {
    const row = document.createElement('tr');
    row.id = `job-${id}`;
    row.innerHTML = `
      <td>${index+1}</td>
      <td>${cvFiles[index].name}</td>
      <td class="contact">-</td>
      <td class="score">0%</td>
      <td class="skills"></td>
      <td class="explanation"></td>
      <td>
        <progress value="0" max="100"></progress>
        <span class="progressText">0%</span>
      </td>
    `;
    tbody.appendChild(row);
  });

  resultsDiv.style.display = 'block';

  // Poll progress every 2s
  const interval = setInterval(() => {
    let allDone = true;
    jobIds.forEach((id, index) => {
      fetch(`/job/${id}/progress`)
        .then(r => r.json())
        .then(job => {
          const row = document.getElementById(`job-${id}`);
          row.querySelector('progress').value = job.progress;
          row.querySelector('.progressText').textContent = job.progress + '%';

          if (job.result) {
            row.querySelector('.score').textContent = job.result.score + '%';
            row.querySelector('.skills').textContent = job.result.matched_skills.join(', ');
            row.querySelector('.explanation').textContent = job.result.explanation;
            row.querySelector('.contact').textContent = job.result.contact;
          }

          if (job.progress < 100) allDone = false;
        });
    });
    if (allDone) clearInterval(interval);
  }, 2000);
}
</script>

</body>
</html>
